---
const { currentPath, lang } = Astro.props;

function getTranslatedPath(path: any, targetLang: any) {
  const pathWithoutLang = path.replace(/^\/(ro|en)/, '');
  return `/${targetLang}${pathWithoutLang || '/'}`;
}

const languages = [
  { code: 'ro', label: 'RomÃ¢nÄƒ', flag: 'ðŸ‡·ðŸ‡´' },
  { code: 'en', label: 'English', flag: 'ðŸ‡ºðŸ‡¸' }
];

const currentLanguage = languages.find(l => l.code === lang) || languages[0];
const otherLanguage = languages.find(l => l.code !== lang) || languages[1];
const switchToUrl = getTranslatedPath(currentPath, otherLanguage.code);
---

<div class="language-dropdown" id="languageDropdown">
  <!-- Desktop: Dropdown cu hover -->
  <button class="language-dropdown__btn language-dropdown__btn--desktop" type="button">
    <span class="language-dropdown__flag">{currentLanguage.flag}</span>
    <span class="language-dropdown__text">{currentLanguage.label}</span>
    <svg class="language-dropdown__arrow" width="12" height="8" viewBox="0 0 12 8" fill="none">
      <path d="M1 1L6 6L11 1" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </button>

  <!-- Mobile: Direct link - DOAR ICON -->
  <a href={switchToUrl} class="language-dropdown__btn language-dropdown__btn--mobile">
    <span class="language-dropdown__flag">{currentLanguage.flag}</span>
  </a>
  
  <div class="language-dropdown__menu">
    {languages.map((language) => (
      <a 
        href={getTranslatedPath(currentPath, language.code)}
        class:list={["language-dropdown__option", { "language-dropdown__option--active": language.code === lang }]}
      >
        <span class="language-dropdown__flag">{language.flag}</span>
        <span class="language-dropdown__text">{language.label}</span>
        {language.code === lang && (
          <svg class="language-dropdown__check" width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path d="M3 8L6.5 11.5L13 5" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        )}
      </a>
    ))}
  </div>
</div>

<style>
  .language-dropdown {
    position: relative;
    font-family: 'Inter', sans-serif;
  }

  /* Bridge pentru hover mai uÈ™or - DOAR DESKTOP */
  .language-dropdown::before {
    content: '';
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    height: 10px;
    background: transparent;
    z-index: 199;
  }

  /* BUTON COMUN */
  .language-dropdown__btn {
    display: flex;
    align-items: center;
    gap: 0.625rem;
    padding: 0.625rem 1rem;
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1.5px solid rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    color: rgba(255, 255, 255, 0.95);
    font-weight: 500;
    font-size: 0.9375rem;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    letter-spacing: 0.01em;
    text-decoration: none;
  }

  .language-dropdown__btn:hover {
    background: rgba(255, 255, 255, 0.15);
    border-color: rgba(255, 255, 255, 0.35);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  /* Mobile button hidden by default */
  .language-dropdown__btn--mobile {
    display: none;
  }

  /* CÃ‚ND NAVBAR ARE CLASA .scrolled SAU .menu-active - NEGRU */
  .language-dropdown.scrolled .language-dropdown__btn,
  .language-dropdown.menu-active .language-dropdown__btn {
    background: rgba(255, 255, 255, 0.95);
    border-color: rgba(0, 0, 0, 0.08);
    color: #1a1a1a;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
  }

  .language-dropdown.scrolled .language-dropdown__btn:hover,
  .language-dropdown.menu-active .language-dropdown__btn:hover {
    background: white;
    border-color: rgba(0, 0, 0, 0.12);
    color: #000000;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
  }

  .language-dropdown__flag {
    font-size: 1.25rem;
    line-height: 1;
    filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
  }

  .language-dropdown__text {
    font-weight: 500;
    letter-spacing: 0.01em;
  }

  .language-dropdown__arrow {
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    opacity: 0.8;
  }

  .language-dropdown:hover .language-dropdown__arrow {
    transform: rotate(180deg);
    opacity: 1;
  }

  /* DROPDOWN MENU - TRANSPARENT CU BLUR INIÈšIAL */
  .language-dropdown__menu {
    position: absolute;
    top: calc(100% + 0.75rem);
    right: 0;
    transform: translateY(-10px) scale(0.95);
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 14px;
    border: 1.5px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 10px 32px rgba(0, 0, 0, 0.2);
    min-width: 180px;
    padding: 0.6rem;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 200;
    pointer-events: none;
  }

  /* DROPDOWN ALB CÃ‚ND E SCROLLED SAU MENU-ACTIVE */
  .language-dropdown.scrolled .language-dropdown__menu,
  .language-dropdown.menu-active .language-dropdown__menu {
    background: rgba(255, 255, 255, 0.98);
    border-color: rgba(0, 0, 0, 0.08);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
  }

  .language-dropdown:hover .language-dropdown__menu {
    opacity: 1;
    visibility: visible;
    transform: translateY(0) scale(1);
    pointer-events: all;
  }

  /* OPÈšIUNI - TEXT ALB INIÈšIAL */
  .language-dropdown__option {
    display: flex;
    align-items: center;
    gap: 0.875rem;
    padding: 0.875rem 1.125rem;
    color: rgba(255, 255, 255, 0.95);
    text-decoration: none;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    font-weight: 500;
    font-size: 0.92rem;
    border-radius: 10px;
    position: relative;
  }

  .language-dropdown__option::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    width: 3px;
    background: currentColor;
    transform: scaleY(0);
    transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .language-dropdown__option:hover {
    background: rgba(255, 255, 255, 0.15);
    color: #ffffff;
    padding-left: 1.25rem;
  }

  .language-dropdown__option:hover::before {
    transform: scaleY(1);
  }

  .language-dropdown__option--active {
    background: rgba(255, 255, 255, 0.2);
    color: #ffffff;
    font-weight: 600;
  }

  .language-dropdown__option--active::before {
    transform: scaleY(1);
  }

  .language-dropdown__check {
    margin-left: auto;
    color: rgba(255, 255, 255, 0.9);
  }

  /* Separator Ã®ntre opÈ›iuni */
  .language-dropdown__option:not(:last-child) {
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  /* OPÈšIUNI NEGRE CÃ‚ND E SCROLLED SAU MENU-ACTIVE */
  .language-dropdown.scrolled .language-dropdown__option,
  .language-dropdown.menu-active .language-dropdown__option {
    color: #1a1a1a;
  }

  .language-dropdown.scrolled .language-dropdown__option:not(:last-child),
  .language-dropdown.menu-active .language-dropdown__option:not(:last-child) {
    border-bottom-color: rgba(0, 0, 0, 0.06);
  }

  .language-dropdown.scrolled .language-dropdown__option:hover,
  .language-dropdown.menu-active .language-dropdown__option:hover {
    background: rgba(0, 0, 0, 0.04);
    color: #000000;
  }

  .language-dropdown.scrolled .language-dropdown__option--active,
  .language-dropdown.menu-active .language-dropdown__option--active {
    background: rgba(0, 0, 0, 0.06);
    color: #000000;
  }

  .language-dropdown.scrolled .language-dropdown__check,
  .language-dropdown.menu-active .language-dropdown__check {
    color: #1a1a1a;
  }

  /* MOBILE */
  @media (max-width: 968px) {
    /* Remove bridge on mobile */
    .language-dropdown::before {
      display: none;
    }

    /* Hide desktop button, show mobile link */
    .language-dropdown__btn--desktop {
      display: none;
    }

    /* Mobile - DOAR ICONIÈšA, FÄ‚RÄ‚ BACKGROUND */
    .language-dropdown__btn--mobile {
      display: flex;
      padding: 0;
      background: transparent;
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
      border: none;
      box-shadow: none;
      transition: transform 0.3s ease;
    }

    .language-dropdown__btn--mobile:hover {
      background: transparent;
      transform: scale(1.15);
      box-shadow: none;
    }

    /* Bigger flag on mobile */
    .language-dropdown__flag {
      font-size: 1.6rem;
      cursor: pointer;
    }

    /* Hide menu on mobile completely */
    .language-dropdown__menu {
      display: none !important;
    }
  }
</style>

<script>
  import { initScrollHandler } from '../../composables/GlobalComposables/scrollHandler.js';

  const navbar = document.getElementById('navbar');
  const languageDropdown = document.getElementById('languageDropdown');
  
  if (languageDropdown) {
    // Scroll handler
    initScrollHandler((isScrolled: any) => {
      if (isScrolled) {
        languageDropdown.classList.add('scrolled');
      } else {
        languageDropdown.classList.remove('scrolled');
      }
    }, 50);

    // Observer for menu-active
    if (navbar) {
      const observer = new MutationObserver(() => {
        if (navbar.classList.contains('menu-active')) {
          languageDropdown.classList.add('menu-active');
        } else {
          languageDropdown.classList.remove('menu-active');
        }
      });

      observer.observe(navbar, {
        attributes: true,
        attributeFilter: ['class']
      });
    }
  }
</script>